(function(e,t){e.widget("neatline.itembrowser",{options:{css:{default_text_size:14,top_margin:40,fader_width:40,container_min_width:400},colors:{light_blue:"#FFFEF8",light_yellow:"#f9f9f9",dark_purple:"#594e62",purple:"#724e85",text:"#515151",gray:"#8d8d8d",red:"#ca3c3c",orange:"#ffda82"}},_create:function(){this._window=e(window),this._body=e("body"),this.topBar=e("#topbar"),this.searchBox=e("#search-box"),this.itemsList=e("#items-list-container"),this.itemsListHeader=e("#items-list-header"),this.searchCancel=e("#search-cancel"),this.neatlineContainer=e("#neatline"),this.dragTip=e("#drag-tip"),this.itemsTip=e("#items-tip"),this.spaceTip=e("#space-tip"),this.timeTip=e("#time-tip"),this.itemsHeader=e("#items-header"),this.spaceHeader=e("#space-header"),this.timeHeader=e("#time-header"),this.editForm=e("#edit-form"),this.newItemButton=e("#new-item-button"),this.headerRow=e("#header-row"),this._searchString="",this._currentFormItem=null,this._currentFormItemId=null,this._itemsBoxes=null,this._spaceBoxes=null,this._timeBoxes=null,this._neatlineRecords=[],this._omekaRecords=[],this._itemsSorted=!1,this._spaceSorted=!1,this._timeSorted=!1,this._firstRequest=!0,this._scrollTop=0,this._scrollbarWidth=e.getScrollbarWidth(),this._addGlobalClasses(),this._positionDivs(),this._addWindowResizeListener(),this._glossSearchBox(),this._glossColumnHeaders(),this._glossNewItemButton(),this._instantiateFormManager(),this._getItems()},_addGlobalClasses:function(){e.browser.mozilla&&this._body.addClass("mozilla")},_positionDivs:function(){this.element.css("width",this.options.css.container_min_width),this._getDimensions(),this.neatlineContainer.css("top",this.topBarHeight),this.element.css({width:this.containerWidth,height:this.windowHeight-this.topBarHeight-1,top:this.topBarHeight}),this.containerOffset=this.element.offset(),this.itemsListHeader.css({top:this.containerOffset.top,width:this.containerWidth-this._scrollbarWidth}),this._positionNeatline()},_getDimensions:function(){this.containerWidth=this.element.width(),this.containerHeight=this.element.height(),this.windowWidth=this._window.width(),this.windowHeight=this._window.height(),this.topBarHeight=this.topBar.height()},_addWindowResizeListener:function(){var e=this;this._window.bind("resize",function(){e._positionDivs()})},_positionNeatline:function(){this.neatlineContainer.css({height:this.windowHeight-this.topBarHeight,width:this.windowWidth-this.containerWidth-1}),this._trigger("reposition")},_positionTitleFaders:function(){var t=this;e.each(this.items,function(t,n){var n=e(n),r=n.find(".item-title-text"),i=n.find(".item-title-fader"),s=r.height();i.css({height:s})})},_calculateTopOffset:function(e){e.data("topOffset",e.position().top)},_calculateAllTopOffsets:function(){var t=this;e.each(this.items,function(n,r){t._calculateTopOffset(e(r))})},_checkStatusBlockOn:function(e,t){var n=e.find("."+t),r=n.find('input[type="checkbox"]');r.prop("checked",!0),e.data(t,!0)},_checkStatusBlockOff:function(e,t){var n=e.find("."+t),r=n.find('input[type="checkbox"]');r.prop("checked",!1),e.data(t,!1)},_checkStatusBlock:function(e,t){var n=e.find("."+t),r=n.find('input[type="checkbox"]'),i=!r.prop("checked");r.prop("checked",i),i?e.data(t,!0):e.data(t,!1)},_instantiateFormManager:function(){var e=this;this.editForm.itemform({ambiguityChange:function(t,n){var r=e._currentFormItem.attr("recordid");e._trigger("ambiguityChange",{},{recordid:r,color:n.color,leftPercent:n.leftPercent,rightPercent:n.rightPercent})},vectorColorEdit:function(t,n){if(!_.isNull(e._currentFormItem)){var r=e._currentFormItem.attr("recordid");e._trigger("vectorcoloredit",{},{recordid:r,color:n.color})}},strokeColorEdit:function(t,n){e._trigger("strokecoloredit",{},{color:n.color})},highlightColorEdit:function(t,n){e._trigger("highlightcoloredit",{},{color:n.color})},vectorOpacityEdit:function(t,n){e._trigger("vectoropacityedit",{},{value:n.value})},strokeOpacityEdit:function(t,n){e._trigger("strokeopacityedit",{},{value:n.value})},graphicOpacityEdit:function(t,n){e._trigger("graphicopacityedit",{},{value:n.value})},strokeWidthEdit:function(t,n){e._trigger("strokewidthedit",{},{value:n.value})},pointRadiusEdit:function(t,n){e._trigger("pointradiusedit",{},{value:n.value})},hide:function(){e._hideForm(e._currentFormItem,!0)},save:function(){e._trigger("saveform")},savecomplete:function(){e._trigger("savecomplete")},spaceactive:function(){e._checkStatusBlockOn(e._currentFormItem,"space")},timeactive:function(){e._checkStatusBlockOn(e._currentFormItem,"time")},savemapfocus:function(){e._trigger("savemapfocus")},reload:function(){e._trigger("savecomplete"),e._getItems()},settitle:function(t,n){e._currentRecordTitle.html(n.text)},updatedid:function(t,n){e._currentFormItem.attr("recordid",n.recordid),e.idToItem[parseInt(n.recordid,10)]=e._currentFormItem},deletecomplete:function(t,n){e._currentFormItem.remove(),e._hideForm(e._currentFormItem,!0),e._glossItems(),e._trigger("savecomplete")}})},_glossSearchBox:function(){var e=this;this.searchBox.bind({keyup:function(){e._searchString=e.searchBox.val(),e._getItems()}}),this.searchCancel.bind({mousedown:function(){e.searchBox.val(""),e.searchBox.trigger("keyup")}})},_glossNewItemButton:function(){var e=this;this.newItemButton.bind({mousedown:function(){e._getNewItemMarkup()}})},_glossColumnHeaders:function(){},_recuperateScrollTop:function(){this.element.scrollTop(this._scrollTop)},_glossItems:function(){var t=this;this.items=this.itemsList.find(".item-row"),this.neatlineRecordsHeader=this.itemsList.find("#neatline-header"),this.omekaRecordsHeader=this.itemsList.find("#omeka-header"),this._positionTitleFaders(),this.idToItem={},this._neatlineRecords=[],this._omekaRecords=[],this._hideHeaderRows(),e.each(this.items,function(n,r){var r=e(r),i=r.find("td"),s=r.attr("recordid"),o=r.find(".item-title"),u=r.find(".item-title-text"),a=r.find(".items"),f=a.find('input[type="checkbox"]'),l=r.find(".space"),c=l.find('input[type="checkbox"]'),h=r.find(".time"),p=h.find('input[type="checkbox"]');r.data("expanded",!1),r.attr("itemid")?t._omekaRecords.push(r):r.attr("recordid")&&t._neatlineRecords.push(r),e.map([r,i,o,u,l,c,h,p],function(e,t){e.unbind()}),t.idToItem[parseInt(s)]=r,t._calculateTopOffset(r),f.prop("checked")?r.data("items",!0):r.data("items",!1),c.prop("checked")?r.data("space",!0):r.data("space",!1),p.prop("checked")?r.data("time",!0):r.data("time",!1),e.each([c,p,f],function(e,t){t.bind("click",function(e){e.preventDefault()})}),r.bind({mouseenter:function(){r.css("background-color",t.options.colors.light_blue)},mouseleave:function(){r.css("background-color",t.options.colors.light_yellow)}}),a.bind({mousedown:function(){t._checkStatusBlock(r,"items"),t._saveStatus(r,"items",!0)},mouseenter:function(){a.css("background-color",t.options.colors.orange)},mouseleave:function(){a.css("background-color","")}}),l.bind({mousedown:function(){t._checkStatusBlock(r,"space"),t._saveStatus(r,"space",!0)},mouseenter:function(){l.css("background-color",t.options.colors.orange)},mouseleave:function(){l.css("background-color","")}}),h.bind({mousedown:function(){t._checkStatusBlock(r,"time"),t._saveStatus(r,"time",!0)},mouseenter:function(){h.css("background-color",t.options.colors.orange)},mouseleave:function(){h.css("background-color","")}}),o.bind({mousedown:function(){r.data("expanded")?t._hideForm(r,!0):t._showForm(r,!0,!0,!0)}})}),this._itemsBoxes=this.items.find(".items"),this._spaceBoxes=this.items.find(".space"),this._timeBoxes=this.items.find(".time"),this._calculateAllTopOffsets(),this._showHeaderRows()},_insertNewRecordRow:function(e){_.isNull(this._currentFormItem)||this._hideForm(this._currentFormItem,!0),this.neatlineRecordsHeader.length===0?this.itemsList.prepend(e):this.neatlineRecordsHeader.after(e),this._glossItems()},_showForm:function(e,t,n,r){if(this._isEditFormLocked())return;var i=this,s=!1,o=e.attr("recordid");_.isNull(this._currentFormItem)||this._hideForm(this._currentFormItem,!0),this._scrollTop=this.element.scrollTop(),this.editForm.itemform("showForm",e),this._trigger("itemedit",{},{recordid:o,scrollMap:t,scrollTimeline:n,focusItems:r}),this._trigger("mapedit",{},{item:e,immediate:s}),e.data("expanded",!0),this._currentFormItem=e,this._currentFormItemId=o,this._currentRecordTitle=e.find("span.item-title-text"),this._hideItemRows()},_hideForm:function(e,t){if(this._isEditFormLocked())return;this.editForm.itemform("hideForm",e,t),this._trigger("endmapedit",{},{immediate:t}),e.data("expanded",!1),this._currentFormItem=null,this._currentFormItemId=null,this._showItemRows(),this._recuperateScrollTop()},_hideItemRows:function(){_.each(this.items,function(t){e(t).data("expanded")?e(t).show():e(t).hide()}),this._hideHeaderRows(),this.element.scrollTop(0)},_showItemRows:function(){_.each(this.items,function(t){e(t).show()}),this._showHeaderRows()},_hideHeaderRows:function(){this.omekaRecordsHeader.hide(),this.neatlineRecordsHeader.hide()},_showHeaderRows:function(){_.isEmpty(this._omekaRecords)||this.omekaRecordsHeader.show(),_.isEmpty(this._neatlineRecords)||this.neatlineRecordsHeader.show()},saveForm:function(e){this.editForm.itemform("saveItemForm",e)},_getItems:function(){var t=this;e.ajax({url:"ajax/items",dataType:"html",data:{exhibit_id:Neatline.record.id,search:this._searchString},success:function(e){t.editForm.itemform("detachForm"),t.itemsList.html(e),t._positionDivs(),t._glossItems(),t._firstRequest&&(t._trigger("neatlineready"),t._firstRequest=!1)}})},_saveStatus:function(t,n,r){var i=this,s=t.find("."+n),o=s.find('input[type="checkbox"]'),u=o.prop("checked"),a=t.attr("recordid"),f=t.attr("itemid"),l=t.find("."+this.options.item_title_text_class);e.ajax({url:"ajax/status",type:"POST",dataType:"json",data:{exhibit_id:Neatline.record.id,item_id:f,record_id:a,space_or_time:n,value:String(u)},success:function(e){t.attr("recordid",e.record_id),i.idToItem[e.record_id]=t,r&&i._trigger("savecomplete")}})},_getNewItemMarkup:function(){var t=this;e.ajax({url:"ajax/add",type:"GET",dataType:"html",data:{exhibit_id:Neatline.record.id},success:function(e){t._insertNewRecordRow(e)}})},setCoverageData:function(e){this.editForm.itemform("setCoverageData",e)},showFormByRecordId:function(e,t,n,r){if(e==this._currentFormItemId)return;var i=this.idToItem[e];this._showForm(i,t,n,r)},saveMapFocus:function(e,t){this.editForm.itemform("postMapFocus",e,t)},reloadItemForm:function(e,t){this.editForm.itemform("reloadForm")},updateGeocoverage:function(e){this.editForm.itemform("updateGeocoverage",e)},getCurrentEditId:function(){return this.editForm.itemform("getCurrentEditId")},getAttr:function(e){return this[e]},_isEditFormLocked:function(){var e=!1;return e=this.editForm.itemform!=null&&this.editForm.itemform("isLocked"),e}})})(jQuery),function(e,t){e.widget("neatline.itemform",{options:{css:{default_text_size:14,form_duration:300},colors:{light_blue:"#f3f6ff",light_yellow:"#fffef8",dark_purple:"#594e62",purple:"#724e85",text:"#515151",gray:"#8d8d8d",red:"#ca3c3c",orange:"#ffda82"},redactor:["html","bold","italic","underline","|","image","link","|","fontcolor","backcolor","|","alignleft","aligncenter","alignright","|","fullscreen"]},_create:function(){this._window=e(window),this.item=this.element.prev("item-row"),this.form=this.element.find("form"),this.deleteButton=this.form.find("#record-delete-button"),this.closeButton=this.form.find("#record-close-button"),this.saveButton=this.form.find("#record-save-button"),this.title=this.form.find('textarea[name="title"]'),this.slug=this.form.find('input[name="slug"]'),this.description=this.form.find('textarea[name="description"]'),this.showBubble=this.form.find('input[name="show-bubble"]'),this.useDcData=this.form.find('input[name="use-dc-data"]'),this.useDcDataLabel=this.useDcData.next("span"),this.startDate=this.form.find('input[name="start-date-date"]'),this.endDate=this.form.find('input[name="end-date-date"]'),this.startVisibleDate=this.form.find('input[name="start-visible-date"]'),this.endVisibleDate=this.form.find('input[name="end-visible-date"]'),this.geocoverage=this.form.find('textarea[name="geocoverage"]'),this.vectorColor=this.form.find('input[name="vector-color"]'),this.strokeColor=this.form.find('input[name="stroke-color"]'),this.highlightColor=this.form.find('input[name="highlight-color"]'),this.vectorOpacity=this.form.find('input[name="vector-opacity"]'),this.selectOpacity=this.form.find('input[name="select-opacity"]'),this.strokeOpacity=this.form.find('input[name="stroke-opacity"]'),this.graphicOpacity=this.form.find('input[name="graphic-opacity"]'),this.strokeWidth=this.form.find('input[name="stroke-width"]'),this.pointRadius=this.form.find('input[name="point-radius"]'),this.pointImage=this.form.find('input[name="point-image"]'),this.leftPercent=this.form.find('input[name="left-ambiguity-percentage"]'),this.rightPercent=this.form.find('input[name="right-ambiguity-percentage"]'),this.textInputs=this.form.find('input[type="text"], textarea'),this.fieldset=this.form.find("fieldset"),this.actions=this.form.find("#edit-form-actions"),this.inputs=this.form.find("#edit-form-inputs"),this.ambiguity=this.form.find(".date-ambiguity-container"),this.mapFocus=this.form.find(".map-focus"),this.resetStyles=this.form.find(".reset-styles"),this.parentRecord=this.form.find('select[name="parent-record"]'),this.titleDescriptionFieldset=this.form.find("a.fieldset.text"),this.dateInformationFieldset=this.form.find("a.fieldset.temporal"),this.mapStylesFieldset=this.form.find("a.fieldset.styles"),this.relationshipsFieldset=this.form.find("a.fieldset.relationships"),this._db=TAFFY(),this._isForm=!1,this._data=null,this.coverage=null,this._isLocked=!1,this._buildFormFunctionality(),this._buildFieldsets(),this._measureForm()},_buildFormFunctionality:function(){var e=this;this.useDcData.bind("change",_.bind(function(){this.useDcData.prop("checked")?(this._disableTextEditors(),this._postDcDefaultStatus(!0)):(this._enableTextEditors(),this._postDcDefaultStatus(!1))},this)),this.ambiguity.gradientbuilder({stopHandleDrag:function(t,n){e._trigger("ambiguityChange",{},{itemId:n.itemId,color:n.color,leftPercent:n.leftPercent,rightPercent:n.rightPercent})}}),this.vectorColor.miniColors({change:function(t,n){e._opened||e._trigger("formEdit"),e._trigger("vectorColorEdit",{},{color:t}),e.ambiguity.gradientbuilder("setColor",t)}}),this.strokeColor.miniColors({change:function(t,n){e._trigger("strokeColorEdit",{},{color:t})}}),this.highlightColor.miniColors({change:function(t,n){e._trigger("highlightColorEdit",{},{color:t})}}),this.vectorOpacity.integerdragger({min:0,max:100,px_per_unit:3,tip:{show:!1},change:function(t,n){e._trigger("vectorOpacityEdit",{},{value:n.value})}}),this.selectOpacity.integerdragger({min:0,max:100,px_per_unit:3,tip:{show:!1},change:function(t,n){e._trigger("selectOpacityEdit",{},{value:n.value})}}),this.strokeOpacity.integerdragger({min:0,max:100,px_per_unit:3,tip:{show:!1},change:function(t,n){e._trigger("strokeOpacityEdit",{},{value:n.value})}}),this.graphicOpacity.integerdragger({min:0,max:100,px_per_unit:3,tip:{show:!1},change:function(t,n){e._trigger("graphicOpacityEdit",{},{value:n.value})}}),this.strokeWidth.integerdragger({min:0,def:1,px_per_unit:8,tip:{show:!1},change:function(t,n){e._trigger("strokeWidthEdit",{},{value:n.value})}}),this.pointRadius.integerdragger({min:1,def:6,px_per_unit:8,tip:{show:!1},change:function(t,n){e._trigger("pointRadiusEdit",{},{value:n.value})}}),this.saveButton.bind({mousedown:function(){e.saveItemForm()},click:function(e){e.preventDefault()}}),this.closeButton.bind({mousedown:function(){e._trigger("hide")},click:function(e){e.preventDefault()}}),this.deleteButton.bind({mousedown:function(){_.isUndefined(this.itemId)&&(e._fadeDown(),e.postRecordDelete())},click:function(e){e.preventDefault()}}),this.mapFocus.bind({mousedown:function(){e._fadeDown(),e._trigger("savemapfocus")},click:function(e){e.preventDefault()}}),this.resetStyles.bind({mousedown:function(){e._fadeDown(),e.postResetStyles()},click:function(e){e.preventDefault()}}),this.textInputs.bind("keydown",function(){e._trigger("formEdit")})},_buildFieldsets:function(){this.form.tabs()},_buildEditors:function(){},_destroyEditors:function(){},showForm:function(e){if(this._isLocked)return;this.item=e;var t=e.attr("itemid"),n=e.attr("recordid");this.itemTitleText=e.find(".item-title-text"),this.container=this.item.next("tr").find("td.edit-form-container"),this.textSpan=this.item.find(".item-title-text"),this.time=this.item.find(".time input"),this.space=this.item.find(".space input"),this.itemId=t===""?null:parseInt(t,10),this.recordId=n===""?null:parseInt(n,10),this.container.append(this.element),this._disableButtons(),this._showContainer(),this._buildEditors(),this._expandTitle(),this._getFormData(),_.isNull(this.itemId)?this._hideItemRecordElements():this._showItemRecordElements(),this._isForm=!0},hideForm:function(e,t){if(this._isLocked)return;this._hideContainer(t),this._contractTitle(),this._destroyEditors(),this._isForm=!1},saveItemForm:function(){this._fadeDown(),this._postFormData()},resizeForm:function(){this._measureForm(),this.form.animate({height:this._nativeHeight},this.options.css.form_duration),this.dateStylesFieldset.fieldsetexpander("isExpanded")&&this.ambiguity.gradientbuilder("refresh")},detachForm:function(){this.element.detach()},reloadForm:function(){this._getFormData()},_disableButtons:function(){this.saveButton.attr("disabled","disabled"),this.deleteButton.attr("disabled","disabled")},_disableCloseButton:function(){this.closeButton.attr("disabled","disabled")},_enableButtons:function(){this.saveButton.removeAttr("disabled"),this.deleteButton.removeAttr("disabled")},_enableCloseButton:function(){this.closeButton.removeAttr("disabled")},_showContainer:function(){this.container.css("display","table-cell"),this.element.css("visibility","visible"),this.form.css("height","auto")},_hideContainer:function(e){var t=this,n=e?0:this.options.css.form_duration;this.form.animate({height:0},n,function(){t.container.css("display","none")})},_expandTitle:function(){this.textSpan.css({"font-weight":"bold",color:this.options.colors.dark_purple})},_contractTitle:function(){var e=this.options.colors.text,t="normal";this.textSpan.data("changed")&&(e=this.options.colors.red,t="bold"),this.textSpan.css("font-weight",t),this.textSpan.stop().animate({color:e,"font-size":this.options.css.default_text_size},100)},_fadeDown:function(){this.element.animate({opacity:.3},200)},_fadeUp:function(){this.element.animate({opacity:1},200)},_updateTitleText:function(){_.isNull(this.itemId)&&(this._data.title!==""?this._trigger("settitle",{},{text:this._data.title}):this._data.description!==""&&this._trigger("settitle",{},{text:this._data.description.substring(0,200)}))},_showItemRecordElements:function(){this.deleteButton.css("visibility","hidden"),this.useDcData.removeAttr("disabled"),this.useDcDataLabel.css("opacity",1)},_hideItemRecordElements:function(){this.deleteButton.css("visibility","visible"),this.useDcData.attr("disabled",!0),this.useDcDataLabel.css("opacity",.3)},_ingestData:function(e){this._data=e,this._records=e.records,this._applyData(),this._enableButtons()},_applyData:function(){var t=Boolean(parseInt(this._data.use_dc_metadata,10)),n=Boolean(parseInt(this._data.show_bubble,10));this.title.val(this._data.title),this.description.val(this._data.description),t?this._disableTextEditors():this._enableTextEditors(),this.slug.val(this._data.slug),this.useDcData.prop("checked",t),this.showBubble.prop("checked",n),this.vectorOpacity.val(this._data.vector_opacity),this.selectOpacity.val(this._data.select_opacity),this.strokeOpacity.val(this._data.stroke_opacity),this.graphicOpacity.val(this._data.graphic_opacity),this.strokeWidth.val(this._data.stroke_width),this.pointRadius.val(this._data.point_radius),this.pointImage.val(this._data.point_image),this.leftPercent.val(this._data.left_percent),this.rightPercent.val(this._data.right_percent),this.startDate.val(this._data.start_date),this.endDate.val(this._data.end_date),this.startVisibleDate.val(this._data.start_visible_date),this.endVisibleDate.val(this._data.end_visible_date),this.geocoverage.val(this._data.geocoverage),this.ambiguity.gradientbuilder("positionMarkers",this._data.left_percent,this._data.right_percent),this.ambiguity.gradientbuilder("setColor",this._data.vector_color),this._opened=!0,this.vectorColor.miniColors("value",this._data.vector_color),this.strokeColor.miniColors("value",this._data.stroke_color),this.highlightColor.miniColors("value",this._data.highlight_color),this._opened=!1,this.parentRecord.empty();var r=e("<option />").val("none").text("-");this.parentRecord.append(r),_.each(this._records,_.bind(function(t,n){if(!_.isNull(t)){var r=e("<option />").val(n).text(t);this.parentRecord.append(r)}},this)),this.parentRecord.val(this._data.parent_record_id)},_getData:function(){var e={};return e.description=this.description.val(),e.title=this.title.val(),e.slug=this.slug.val(),e.use_dc_metadata=this.useDcData.is(":checked")?1:0,e.show_bubble=this.showBubble.is(":checked")?1:0,e.left_percent=parseInt(this.leftPercent.val(),10),e.right_percent=parseInt(this.rightPercent.val(),10),e.start_date=this.startDate.val(),e.end_date=this.endDate.val(),e.start_visible_date=this.startVisibleDate.val(),e.end_visible_date=this.endVisibleDate.val(),e.vector_color=this.vectorColor.val(),e.stroke_color=this.strokeColor.val(),e.highlight_color=this.highlightColor.val(),e.vector_opacity=parseInt(this.vectorOpacity.val(),10),e.select_opacity=parseInt(this.selectOpacity.val(),10),e.stroke_opacity=parseInt(this.strokeOpacity.val(),10),e.graphic_opacity=parseInt(this.graphicOpacity.val(),10),e.stroke_width=parseInt(this.strokeWidth.val(),10),e.point_radius=parseInt(this.pointRadius.val(),10),e.point_image=this.pointImage.val(),e.parent_record_id=parseInt(this.parentRecord.val(),10),e.use_dc_metadata&&(e.description=""),e},_getDataForSave:function(){var e=this._getData();return e.item_id=this.itemId,e.record_id=this.recordId,e.exhibit_id=Neatline.record.id,e.space_active=this.space.prop("checked").toString(),e.time_active=this.time.prop("checked").toString(),e.geocoverage=this.geocoverage.val(),e},_disableTextEditors:function(){},_enableTextEditors:function(){},updateGeocoverage:function(e){this.geocoverage.val(e)},_getFormData:function(){e.ajax({url:"ajax/form",dataType:"json",data:{item_id:this.itemId,record_id:this.recordId,exhibit_id:Neatline.record.id},success:_.bind(function(e){this._ingestData(e)},this)})},_postFormData:function(t){var n=this,r=this._getDataForSave();e.ajax({url:"ajax/save",dataType:"json",type:"POST",data:r,success:function(e){n._fadeUp(),n._trigger("savecomplete"),e.statuses.space&&n._trigger("spaceactive"),e.statuses.time&&n._trigger("timeactive"),n._trigger("updatedid",{},{recordid:e.recordid}),n._ingestData(e.form),n._updateTitleText()}})},postMapFocus:function(t,n){var r=this;e.ajax({url:"ajax/focus",type:"POST",data:{item_id:this.itemId,record_id:this.recordId,exhibit_id:Neatline.record.id,center:t,zoom:n},success:function(){r._fadeUp(),r._trigger("spaceactive"),r._trigger("savecomplete")}})},postRecordDelete:function(){var t=this;e.ajax({url:"ajax/delete",type:"POST",data:{exhibit_id:Neatline.record.id,record_id:this.recordId},success:function(){t._fadeUp(),t._trigger("deletecomplete")}})},postResetStyles:function(){var t=this;e.ajax({url:"ajax/resetstyles",type:"POST",data:{exhibit_id:Neatline.record.id,record_id:this.recordId},success:function(){t._fadeUp(),t._trigger("savecomplete"),t._getFormData()}})},_postDcDefaultStatus:function(t){var n=this;e.ajax({url:"ajax/dcdefault",type:"POST",dataType:"html",data:{exhibit_id:Neatline.record.id,item_id:this.itemId,record_id:this.recordId,status:t?1:0},success:_.bind(function(e){this.description.setCode(e),n._trigger("savecomplete")},this)})},_measureForm:function(){this._nativeHeight=this.actions.position().top+this.actions.height()},getCurrentEditId:function(){return this._isForm?this.recordId:!1},insertLocalData:function(e){this._db.insert(e)},clearLocalData:function(){this._db().remove()},getAttr:function(e){return this[e]},lockForm:function(){this._isLocked=!0,this._disableCloseButton()},unlockForm:function(){this._isLocked=!1,this._enableCloseButton()},isLocked:function(){return this._isLocked}})}(jQuery),function(e,t){e.widget("neatline.editgeometry",{options:{markup:{geo_edit_class:"geo-edit"},animation:{fade_duration:500}},_create:function(){var t=this;this.editContainer=e("#geo-edit"),this.scaleButton=e("#scale-button"),this.rotateButton=e("#rotate-button"),this.dragButton=e("#drag-button"),this.deleteButton=e("#delete-button"),this.element.append(this.editContainer),this.scaleButton.data("activated",!1),this.rotateButton.data("activated",!1),this.dragButton.data("activated",!1),this.dragButton.bind({mousedown:function(){t.dragButton.data("activated")?(t.dragButton.removeClass("btn-neatline"),t.dragButton.data("activated",!1)):(t.dragButton.addClass("btn-neatline"),t.dragButton.data("activated",!0)),t._trigger("update",{},{drag:t.dragButton.data("activated"),rotate:t.rotateButton.data("activated"),scale:t.scaleButton.data("activated")})}}),this.scaleButton.bind({mousedown:function(){t.scaleButton.data("activated")?(t.scaleButton.removeClass("btn-neatline"),t.scaleButton.data("activated",!1)):(t.scaleButton.addClass("btn-neatline"),t.scaleButton.data("activated",!0)),t._trigger("update",{},{drag:t.dragButton.data("activated"),rotate:t.rotateButton.data("activated"),scale:t.scaleButton.data("activated")})}}),this.rotateButton.bind({mousedown:function(){t.rotateButton.data("activated")?(t.rotateButton.removeClass("btn-neatline"),t.rotateButton.data("activated",!1)):(t.rotateButton.addClass("btn-neatline"),t.rotateButton.data("activated",!0)),t._trigger("update",{},{drag:t.dragButton.data("activated"),rotate:t.rotateButton.data("activated"),scale:t.scaleButton.data("activated")})}}),this.deleteButton.bind({mousedown:function(){t._trigger("delete")}})},positionControls:function(e,t,n,r){this.editContainer.css({top:e+55,left:t+65})},showButtons:function(){this.editContainer.css({display:"block",opacity:0,"z-index":999}).stop().animate({opacity:1},this.options.animation.fade_duration),this.deactivateAllButtons()},hideButtons:function(){var e=this;this.editContainer.stop().animate({opacity:0},this.options.markup.fade_duration,function(){e.editContainer.css("z-index",-99)})},deactivateAllButtons:function(){this.dragButton.removeClass("primary"),this.dragButton.data("activated",!1),this.scaleButton.removeClass("primary"),this.scaleButton.data("activated",!1),this.rotateButton.removeClass("primary"),this.rotateButton.data("activated",!1)}})}(jQuery),function(e,t){e.widget("neatline.layoutbuilder",{options:{css:{gloss_fade_duration:300,vt1_percentage:15,vt2_percentage:85},colors:{map:{def:"#fff",target:"#fffcf4"},timeline:{def:"#fff",target:"#fffcf4"},items:{def:"#fff",target:"#fffcf4"}}},_create:function(){this._window=e(window),this.buttons=e("#options"),this.dragbox=e("#drag-box"),this._lastMapParams=null,this._lastTimelineParams=null,this._lastItemsParams=null,this._disableSelect(),this._createDraggers(),this._instantiatePositioner(),this.getPxConstants(),this._createButtons(),this._setStartingParameters(),this._addDragEvents()},_instantiatePositioner:function(){var e=this;this.dragbox.positioner({markup:{map:"#drag-map",timeline:"#drag-timeline",items:"#drag-items"},constants:{h_percent:Neatline.proportions.horizontal,v_percent:Neatline.proportions.vertical},mapFullscreen:!1,drag:function(t,n){e._trigger("widthDrag",{},n),e.centerAllTags(),e.getPxConstants(),e._computePositions()},layoutChange:function(t,n){e.centerAllTags(),e.getPxConstants(),e._computePositions()}})},_setStartingParameters:function(){this._top_element=Neatline.record.top_element,this._items_h_pos=Neatline.record.items_h_pos,this._items_v_pos=Neatline.record.items_v_pos,this._items_height=Neatline.record.items_height,this._is_map=Boolean(Neatline.record.is_map),this._is_timeline=Boolean(Neatline.record.is_timeline),this._is_items=Boolean(Neatline.record.is_items),this._computePositions(),this.map_toggle.togglebutton("enable"),this.timeline_toggle.togglebutton("enable"),this.items_toggle.togglebutton("enable"),this._is_map?(this._is_map=!1,this.map_toggle.togglebutton("press")):this._is_map=!1,this._is_timeline?(this._is_timeline=!1,this.timeline_toggle.togglebutton("press")):this._is_timeline=!1,this._is_items?(this._is_items=!1,this.items_toggle.togglebutton("press")):this._is_items=!1},getPxConstants:function(){this.dragbox.positioner("measure"),this.width=this.dragbox.positioner("getAttr","width"),this.height=this.dragbox.positioner("getAttr","height"),this.minorWidth=this.dragbox.positioner("getAttr","minorWidth"),this.majorWidth=this.dragbox.positioner("getAttr","majorWidth"),this.majorHeight=this.dragbox.positioner("getAttr","majorHeight"),this.minorHeight=this.dragbox.positioner("getAttr","minorHeight"),this.dragboxOffset=this.dragbox.offset(),this.vt1=this.height*(this.options.css.vt1_percentage/100),this.vt2=this.height*(this.options.css.vt2_percentage/100)},_computePositions:function(){this.positions=this.dragbox.positioner("compute",this._is_map,this._is_timeline,this._is_items,this._top_element,this._items_v_pos,this._items_h_pos,this._items_height)},_disableSelect:function(){this.element.css("MozUserSelect","none"),this.element.bind("selectstart mousedown",function(){return!1}),this.dragbox.css("cursor","default")},_createButtons:function(){var t=this;this.map_toggle=e("#toggle-map"),this.timeline_toggle=e("#toggle-timeline"),this.items_toggle=e("#toggle-items"),this.map_toggle.togglebutton({pressed_by_default:!1,enabled_by_default:!1,press:function(){t._toggleMap()},unpress:function(){t._toggleMap()}}),this.timeline_toggle.togglebutton({pressed_by_default:!1,enabled_by_default:!1,press:function(){t._toggleTimeline()},unpress:function(){t._toggleTimeline()}}),this.items_toggle.togglebutton({pressed_by_default:!1,enabled_by_default:!1,press:function(){t._toggleItems()},unpress:function(){t._toggleItems()}})},_createDraggers:function(){this.map_drag=this.__createMapDiv(),this.timeline_drag=this.__createTimelineDiv(),this.items_drag=this.__createItemsDiv(),this.dragbox.append(this.map_drag,this.timeline_drag,this.items_drag)},_addDragEvents:function(){var e=this;this.map_drag.bind({mouseenter:function(){e._is_dragging||e.__mapHighlight("enter")},mouseleave:function(){e._is_dragging||e.__mapHighlight("leave")},mousedown:function(t){e._is_dragging||(e._current_dragger="map",e.__doMapDrag(t))}}),this.timeline_drag.bind({mouseenter:function(){e._is_dragging||e.__timelineHighlight("enter")},mouseleave:function(){e._is_dragging||e.__timelineHighlight("leave")},mousedown:function(t){e._is_dragging||(e._current_dragger="timeline",e.__doTimelineDrag(t))}}),this.items_drag.bind({mouseenter:function(){e._is_dragging||e.__itemsHighlight("enter")},mouseleave:function(){e._is_dragging||e.__itemsHighlight("leave")},mousedown:function(t){e._is_dragging||(e._current_dragger="items",e.__doItemsDrag(t))}})},applyProportions:function(e,t){this.dragbox.positioner("applyProportions",e,t),this.centerAllTags()},_reposition:function(){this.dragbox.positioner("apply"),this.centerAllTags()},_position_tag:function(e){var t=e.find(".drag-tag"),n=e.height(),r=t.height();t.css("top",n/2-r/2+"px")},centerAllTags:function(){this._position_tag(this.map_drag),this._position_tag(this.timeline_drag),this._position_tag(this.items_drag)},_toggleMap:function(){switch(this._is_map){case!0:this._is_map=!1,!this._is_timeline&&this._is_items&&this.items_toggle.togglebutton("press");break;case!1:this._is_map=!0}this._computePositions(),this._reposition()},_toggleTimeline:function(){switch(this._is_timeline){case!0:this._is_timeline=!1,!this._is_map&&this._is_items&&this.items_toggle.togglebutton("press");break;case!1:this._is_timeline=!0}this._computePositions(),this._reposition()},_toggleItems:function(){switch(this._is_items){case!0:this._is_items=!1;break;case!1:this._is_items=!0}this._computePositions(),this._reposition()},_animate_position_tag:function(e,t){var n=e.find(".drag-tag"),r=n.height();n.stop().animate({top:t/2-r/2+"px"})},__mapHighlight:function(e){switch(e){case"enter":var t=this.options.colors.map.target;break;case"leave":var t=this.options.colors.map.def}this.map_drag.clearQueue().animate({"background-color":t},this.options.css.gloss_fade_duration)},__timelineHighlight:function(e){switch(e){case"enter":var t=this.options.colors.timeline.target;break;case"leave":var t=this.options.colors.timeline.def}this.timeline_drag.clearQueue().animate({"background-color":t},this.options.css.gloss_fade_duration)},__itemsHighlight:function(e){switch(e){case"enter":var t=this.options.colors.items.target;break;case"leave":var t=this.options.colors.items.def}this.items_drag.clearQueue().animate({"background-color":t},this.options.css.gloss_fade_duration)},__doMapDrag:function(e){var t=this;this._is_dragging=!0;var n=e.pageX,r=e.pageY,i=this.positions.map.left,s=this.positions.map.top;this.__fadeDragger(this.map_drag),this._window.bind({mousemove:function(e){var o=e.pageX-n,u=e.pageY-r;t.map_drag.css({left:i+o,top:s+u}),t._is_timeline&&t._is_items?(t._top_element==="map"?e.pageY>t.dragboxOffset.top+t.majorHeight&&(t._top_element="timeline",t.__slideTimeline(!1),t.__slideItems(!1)):t._top_element==="timeline"&&e.pageY<t.dragboxOffset.top+t.majorHeight&&(t._top_element="map",t.__slideTimeline(!1),t.__slideItems(!1)),t.__mapIsLevelWithItems()&&(t._items_h_pos==="right"?e.pageX>t.dragboxOffset.left+t.majorWidth&&(t._items_h_pos="left",t.__slideItems(!1)):t._items_h_pos==="left"&&e.pageX<t.dragboxOffset.left+t.minorWidth&&(t._items_h_pos="right",t.__slideItems(!1)))):t._is_timeline&&!t._is_items?t._top_element==="map"?e.pageY>t.dragboxOffset.top+t.majorHeight&&(t._top_element="timeline",t.__slideTimeline(!1)):t._top_element==="timeline"&&e.pageY<t.dragboxOffset.top+t.majorHeight&&(t._top_element="map",t.__slideTimeline(!1)):!t._is_timeline&&t._is_items&&t.__mapIsLevelWithItems()&&(t._items_h_pos==="right"?e.pageX>t.dragboxOffset.left+t.majorWidth&&(t._items_h_pos="left",t.__slideItems(!1)):t._items_h_pos==="left"&&e.pageX<t.dragboxOffset.left+t.minorWidth&&(t._items_h_pos="right",t.__slideItems(!1)))},mouseup:function(){t.__slideMap(!0),t._window.unbind("mousemove mouseup")}})},__doTimelineDrag:function(e){var t=this;this._is_dragging=!0;var n=e.pageX,r=e.pageY,i=this.positions.timeline.left,s=this.positions.timeline.top;this.__fadeDragger(this.timeline_drag),this._window.bind({mousemove:function(e){var o=e.pageX-n,u=e.pageY-r;t.timeline_drag.css({left:i+o,top:s+u}),t._is_map&&t._is_items?(t._top_element==="timeline"?e.pageY>t.dragboxOffset.top+t.majorHeight&&(t._top_element="map",t.__slideMap(!1),t.__slideItems(!1)):t._top_element==="map"&&e.pageY<t.dragboxOffset.top+t.majorHeight&&(t._top_element="timeline",t.__slideMap(!1),t.__slideItems(!1)),t.__timelineIsLevelWithItems()&&(t._items_h_pos==="right"?e.pageX>t.dragboxOffset.left+t.majorWidth&&(t._items_h_pos="left",t.__slideItems(!1)):t._items_h_pos==="left"&&e.pageX<t.dragboxOffset.left+t.minorWidth&&(t._items_h_pos="right",t.__slideItems(!1)))):t._is_map&&!t._is_items?t._top_element==="timeline"?e.pageY>t.dragboxOffset.top+t.majorHeight&&(t._top_element="map",t.__slideMap(!1)):t._top_element==="map"&&e.pageY<t.dragboxOffset.top+t.majorHeight&&(t._top_element="timeline",t.__slideMap(!1)):!t._is_map&&t._is_items&&t.__timelineIsLevelWithItems()&&(t._items_h_pos==="right"?e.pageX>t.dragboxOffset.left+t.majorWidth&&(t._items_h_pos="left",t.__slideItems(!1)):t._items_h_pos==="left"&&e.pageX<t.dragboxOffset.left+t.minorWidth&&(t._items_h_pos="right",t.__slideItems(!1)))},mouseup:function(){t.__slideTimeline(!0),t._window.unbind("mousemove mouseup")}})},__doItemsDrag:function(e){var t=this;this._is_dragging=!0;var n=e.pageX,r=e.pageY,i=this.positions.items.left,s=this.positions.items.top;this.__fadeDragger(this.items_drag),this._window.bind({mousemove:function(e){var o=e.pageX-n,u=e.pageY-r;t.items_drag.css({left:i+o,top:s+u}),t._is_map&&t._is_timeline?(e.pageY<t.dragboxOffset.top+t.vt1&&(t._items_height="partial",t._items_v_pos="top",t.__slideMap(!1),t.__slideTimeline(!1)),e.pageY>t.dragboxOffset.top+t.vt1&&e.pageY<t.dragboxOffset.top+t.vt2&&(t._items_height="full",t.__slideMap(!1),t.__slideTimeline(!1)),e.pageY>t.dragboxOffset.top+t.vt2&&(t._items_height="partial",t._items_v_pos="bottom",t.__slideMap(!1),t.__slideTimeline(!1)),t.__mapIsLevelWithItems()&&(t._items_h_pos==="right"&&e.pageX<t.dragboxOffset.left+t.width/2&&(t._items_h_pos="left",t.__slideMap(!1)),t._items_h_pos==="left"&&e.pageX>t.dragboxOffset.left+t.width/2&&(t._items_h_pos="right",t.__slideMap(!1))),t.__timelineIsLevelWithItems()&&(t._items_h_pos==="right"&&e.pageX<t.dragboxOffset.left+t.width/2&&(t._items_h_pos="left",t.__slideTimeline(!1)),t._items_h_pos==="left"&&e.pageX>t.dragboxOffset.left+t.width/2&&(t._items_h_pos="right",t.__slideTimeline(!1))),t._items_height==="full"&&(t._items_h_pos==="right"&&e.pageX<t.dragboxOffset.left+t.width/2&&(t._items_h_pos="left",t.__slideMap(!1),t.__slideTimeline(!1)),t._items_h_pos==="left"&&e.pageX>t.dragboxOffset.left+t.width/2&&(t._items_h_pos="right",t.__slideMap(!1),t.__slideTimeline(!1)))):t._is_map&&!t._is_timeline?(t._items_h_pos==="right"&&e.pageX<t.dragboxOffset.left+t.width/2&&(t._items_h_pos="left",t.__slideMap(!1)),t._items_h_pos==="left"&&e.pageX>t.dragboxOffset.left+t.width/2&&(t._items_h_pos="right",t.__slideMap(!1))):!t._is_map&&t._is_timeline&&(t._items_h_pos==="right"&&e.pageX<t.dragboxOffset.left+t.width/2&&(t._items_h_pos="left",t.__slideTimeline(!1)),t._items_h_pos==="left"&&e.pageX>t.dragboxOffset.left+t.width/2&&(t._items_h_pos="right",t.__slideTimeline(!1)))},mouseup:function(){t.__slideItems(!0),t._window.unbind("mousemove mouseup")}})},__slideTimeline:function(t){var n=this,r=[this._top_element,this._items_h_pos,this._items_v_pos,this._items_height];if(!e.compare(r,this.lastTimelineParams)||this._current_dragger==="timeline")this._computePositions(),t?this.timeline_drag.stop().animate({height:this.positions.timeline.height,width:this.positions.timeline.width,top:this.positions.timeline.top,left:this.positions.timeline.left,opacity:1,"z-index":0},function(){n._is_dragging=!1,n.timeline_drag.trigger("mouseleave")}):this.timeline_drag.stop().animate({height:this.positions.timeline.height,width:this.positions.timeline.width,top:this.positions.timeline.top,left:this.positions.timeline.left}),this._animate_position_tag(this.timeline_drag,this.positions.timeline.height),this.lastTimelineParams=[this._top_element,this._items_h_pos,this._items_v_pos,this._items_height]},__slideMap:function(t){var n=this,r=[this._top_element,this._items_h_pos,this._items_v_pos,this._items_height];if(!e.compare(r,this.lastMapParams)||this._current_dragger==="map")this._computePositions(),t?this.map_drag.stop().animate({height:this.positions.map.height,width:this.positions.map.width,top:this.positions.map.top,left:this.positions.map.left,opacity:1,"z-index":0},function(){n._is_dragging=!1,n.map_drag.trigger("mouseleave")}):this.map_drag.stop().animate({height:this.positions.map.height,width:this.positions.map.width,top:this.positions.map.top,left:this.positions.map.left}),this._animate_position_tag(this.map_drag,this.positions.map.height),this.lastMapParams=[this._top_element,this._items_h_pos,this._items_v_pos,this._items_height]},__slideItems:function(t){var n=this,r=[this._top_element,this._items_h_pos,this._items_v_pos,this._items_height];if(!e.compare(r,this.lastItemParams)||this._current_dragger==="items")this._computePositions(),t?this.items_drag.stop().animate({height:this.positions.items.height,width:this.positions.items.width,top:this.positions.items.top,left:this.positions.items.left,opacity:1,"z-index":0},function(){n._is_dragging=!1,n.items_drag.trigger("mouseleave")}):this.items_drag.stop().animate({height:this.positions.items.height,width:this.positions.items.width,top:this.positions.items.top,left:this.positions.items.left}),this._animate_position_tag(this.items_drag,this.positions.items.height),this.lastItemParams=[this._top_element,this._items_h_pos,this._items_v_pos,this._items_height]},__createMapDiv:function(){return e('<div id="drag-map" class="draggable">                        <span class="drag-tag">Map</span>                      </div>')},__createTimelineDiv:function(){return e('<div id="drag-timeline" class="draggable">                        <span class="drag-tag">Timeline</span>                      </div>')},__createItemsDiv:function(){return e('<div id="drag-items" class="draggable">                        <span class="drag-tag">Items</span>                      </div>')},__fadeDragger:function(e){e.css({opacity:.5,"z-index":99})},__mapIsLevelWithItems:function(){if(this._is_map&&this._is_timeline&&this._is_items){if(this._top_element==="map"&&this._items_height==="partial"&&this._items_v_pos==="top")return!0;if(this._top_element==="timeline"&&this._items_height==="partial"&&this._items_v_pos==="bottom")return!0}else if(this._is_map&&!this._is_timeline&&this._is_items)return!0;return!1},__timelineIsLevelWithItems:function(){if(this._is_map&&this._is_timeline&&this._is_items){if(this._top_element==="timeline"&&this._items_height==="partial"&&this._items_v_pos==="top")return!0;if(this._top_element==="map"&&this._items_height==="partial"&&this._items_v_pos==="bottom")return!0}else if(!this._is_map&&this._is_timeline&&this._is_items)return!0;return!1},getArrangementParameters:function(){var e=this._is_map?1:0,t=this._is_timeline?1:0,n=this._is_items?1:0,r=this.dragbox.positioner("getAttr","options");return{exhibit_id:Neatline.record.id,is_map:e,is_timeline:t,is_items:n,top_element:this._top_element,items_h_pos:this._items_h_pos,items_v_pos:this._items_v_pos,items_height:this._items_height,h_percent:r.constants.h_percent,v_percent:r.constants.v_percent}},getAttr:function(e){return this[e]}}),e.extend({compare:function(t,n){if(_.isUndefined(t)||_.isUndefined(n))return!1;if(t.length!==n.length)return!1;var r=e.extend(!0,[],t),i=e.extend(!0,[],n);r.sort(),i.sort();for(var s=0,o=r.length;s<o;s++)if(r[s]!==i[s])return!1;return!0}})}(jQuery),function(e,t){e.widget("neatline.itemorderer",e.extend({},e.neatline.neatlineitems.prototype,{_create:function(){return this._isOrdering=!1,this._dragId=null,e.neatline.neatlineitems.prototype._create.apply(this,arguments)},_getRowOrder:function(){var t=this;this._order=[];var n=this.element.find(".item-title");e.each(n,function(n,r){var r=e(r);t._order.push(parseInt(r.attr("recordid")))})},reorder:function(){_.isNull(this._currentRecord)||this.contractDescription(this._currentRecord),this.element.disableSelection(),this.__hideAllDescriptions(),this._addOrderingEventsToItems(),this._isOrdering=!0,this._getRowOrder()},endreorder:function(){return this.__setPointerCursor(),this._getItemOffsets(),this._removeOrderingEventsToItems(),this._isOrdering=!1,this.objectifyOrder()},_addOrderingEventsToItems:function(){var t=this;t.__setMoveCursor(),e.each(this.items,function(n,r){var r=e(r);r.unbind("mousedown"),r.bind("mousedown",function(){t._doItemDrag(r)})})},_removeOrderingEventsToItems:function(){var t=this;e.each(this.items,function(t,n){var n=e(n);n.unbind("mousedown")}),this.loadData()},_doItemDrag:function(t){var n=this,r=t.next("li.item-description");this._getRowOrder(),this._dragId=parseInt(t.attr("recordid")),this.__fadeItem(t),e.each(this.items,function(i,s){var s=e(s),o=parseInt(s.attr("recordid")),u=s.next("li.item-description");s.bind({mouseenter:function(){o!=n._dragId&&(n._order.indexOf(o)<n._order.indexOf(n._dragId)?(t.detach().insertBefore(s),r.detach().insertAfter(t)):n._order.indexOf(o)>n._order.indexOf(n._dragId)&&(t.detach().insertAfter(u),r.detach().insertAfter(t))),n._getRowOrder()}})}),this._window.bind({mouseup:function(){n._endItemDrag(t)}})},_endItemDrag:function(e){this.__unfadeItem(e),this._window.unbind("mouseup"),this.items.unbind("mouseenter")},__hideAllDescriptions:function(){var t=this;e.each(this.items,function(t,n){var n=e(n),r=n.next("li.item-description");r.css("display","none")})},__setMoveCursor:function(){e.each(this.items,function(t,n){e(n).css("cursor","move")})},__setPointerCursor:function(){e.each(this.items,function(t,n){e(n).css("cursor","pointer")})},__fadeItem:function(e){e.css("opacity",.4)},__unfadeItem:function(e){e.css("opacity",1)},__fadeItems:function(){this.items.animate({opacity:.3},200)},__unfadeItems:function(){this.items.animate({opacity:1},200)},objectifyOrder:function(){var t={};return e.each(this._order,function(e,n){t[n]=e}),t}})),e.neatline.neatlineitems.defaults=e.extend({},e.neatline.neatlineitems.defaults)}(jQuery),function(e,t){e.widget("neatline.mapeditor",e.extend({},e.neatline.neatlinemap.prototype,{_create:function(){return this._instantiateEditor(),this.toolbar=null,e.neatline.neatlinemap.prototype._create.apply(this,arguments)},_instantiateEditor:function(){var e=this;this.element.editgeometry({update:function(t,n){e.modifyFeatures.mode=OpenLayers.Control.ModifyFeature.RESHAPE,n.rotate&&(e.modifyFeatures.mode|=OpenLayers.Control.ModifyFeature.ROTATE),n.scale&&(e.modifyFeatures.mode|=OpenLayers.Control.ModifyFeature.RESIZE),n.drag&&(e.modifyFeatures.mode|=OpenLayers.Control.ModifyFeature.DRAG);if(n.drag||n.rotate)e.modifyFeatures.mode&=-OpenLayers.Control.ModifyFeature.RESHAPE;var r=e.modifyFeatures.feature;r!==null&&(e.modifyFeatures.unselectFeature(r),e.modifyFeatures.selectFeature(r))},"delete":function(){if(!_.isUndefined(e.modifyFeatures)&&e.modifyFeatures.feature){var t=e.modifyFeatures.feature;e.modifyFeatures.unselectFeature(t),e._currentEditLayer.destroyFeatures([t]),e._trigger("featureadded",{},{geocoverage:e.getWktForSave()})}}})},edit:function(t,n){var r=this,i=t.attr("recordid"),s=t.attr("itemid");i!==""?(this.record=this._db({recordid:parseInt(i,10)}).first(),this._currentEditLayer=this.record.layer):s!==""&&(this.record=this._db({itemid:parseInt(s,10)}).first(),this._currentEditLayer=this.record.layer),this._currentEditItem=t;if(!this._currentEditLayer){var o=t.find("span.item-title-text").text(),u=new OpenLayers.Layer.Vector(o);this._currentEditLayer=u,this._currentVectorLayers.push(this._currentEditLayer),this.map.addLayer(this._currentEditLayer),this._currentEditLayer.setMap(this.map),r._db.insert({itemid:s,layerid:u.id,recordid:i,data:t,layer:u})}this.panelControls=this._buildPanelControls(),this.panelControls[0].events.register("activate",this,function(e){r.element.trigger("drawingmodeoff")});var a,f=this.panelControls.length;for(a=1;a<f;a++){var l=this.panelControls[a];l.events.register("activate",this,function(e){r.element.trigger("drawingmodeon")}),l.events.register("deactivate",this,function(e){r.element.trigger("drawingmodeoff")})}this.modifyFeatures=new OpenLayers.Control.ModifyFeature(this._currentEditLayer,{standalone:!0,onModification:function(){r._trigger("featureadded",{},{geocoverage:r.getWktForSave()}),r._addClickControls()}}),this.editToolbar=new OpenLayers.Control.Panel({defaultControl:this.panelControls[0],displayClass:"olControlEditingToolbar"}),this.editToolbar.addControls(this.panelControls),this.map.addControl(this.editToolbar),this.map.addControl(this.modifyFeatures),this.modifyFeatures.activate(),this.toolbar=e(".olControlEditingToolbar"),this._popUpEditControls(),this._positionToolbar()},endEditWithoutSave:function(e){_.isUndefined(this.modifyFeatures)||(this.modifyFeatures.unselectFeature(this._clickedFeature),this.map.removeControl(this.modifyFeatures)),this.map.removeControl(this.editToolbar),this.element.editgeometry("hideButtons"),this._currentEditItem=null,this.record=null,this._addClickControls()},getWktForSave:function(){var e=[];_.isUndefined(this.modifyFeatures)||this.modifyFeatures.unselectFeature(this._clickedFeature),this.cancelSketch();var t=new OpenLayers.Format.KML,n=t.write(this._currentEditLayer.features);if(!_.isUndefined(this.modifyFeatures)&&!_.isNull(this._clickedFeature))try{this.modifyFeatures.selectFeature(this._clickedFeature)}catch(r){}return n},cancelSketch:function(){_.each(this.panelControls.slice(1,4),function(e){e.cancel()})},getExtentForSave:function(){return this.map.getExtent().toString()},getCenterForSave:function(){return this.map.getCenter().toShortString()},getZoomForSave:function(){return this.map.getZoom()},getBaseLayerForSave:function(){return this.map.baseLayer.name},setCurrentRecordStyle:function(t,n){var r=this;if(_.isNull(this.record)||_.isUndefined(this.record.data))return;this.record.data[t]=n,this._currentEditLayer.styleMap=this._getStyleMap(this.record.data.vector_color,this.record.data.vector_opacity,this.record.data.stroke_color,this.record.data.stroke_opacity,this.record.data.stroke_width,this.record.data.point_radius,this.record.data.point_image,this.record.data.highlight_color,this.record.data.select_opacity,this.record.data.graphic_opacity),this._currentEditLayer.redraw(),e.each(this._currentEditLayer.features,function(e,t){r.highlightControl.unhighlight(t)})},setDefaultStyle:function(t,n){var r=this;this._db().each(function(i,s){_.isNull(i.data._native_styles[t])&&(i.data[t]=n,i.layer.styleMap=r._getStyleMap(i.data.vector_color,i.data.vector_opacity,i.data.stroke_color,i.data.stroke_opacity,i.data.stroke_width,i.data.point_radius,i.data.point_image,i.data.highlight_color,i.data.select_opacity,i.data.graphic_opacity),e.each(i.layer.features,function(e,t){r.highlightControl.unhighlight(t)}))})},_buildPanelControls:function(){var e=this;return[new OpenLayers.Control.Navigation,new OpenLayers.Control.DrawFeature(this._currentEditLayer,OpenLayers.Handler.Path,{displayClass:"olControlDrawFeaturePath",featureAdded:function(){e._trigger("featureadded",{},{geocoverage:e.getWktForSave()}),e._addClickControls()}}),new OpenLayers.Control.DrawFeature(this._currentEditLayer,OpenLayers.Handler.Point,{displayClass:"olControlDrawFeaturePoint",featureAdded:function(){e._trigger("featureadded",{},{geocoverage:e.getWktForSave()}),e._addClickControls()}}),new OpenLayers.Control.DrawFeature(this._currentEditLayer,OpenLayers.Handler.Polygon,{displayClass:"olControlDrawFeaturePolygon",featureAdded:function(){e._trigger("featureadded",{},{geocoverage:e.getWktForSave()}),e._addClickControls()}})]},_popUpEditControls:function(){this.element.editgeometry("showButtons",!1),this.toolbar.css("opacity",1)},_positionToolbar:function(){if(_.isNull(this.toolbar))return;this.toolbar.css({top:this.pos.top+17,left:this.pos.left+60})},refresh:function(e){this.pos=e,this.map.updateSize(),this.positionControls(e.top,e.left,e.width,e.height),this.element.editgeometry("positionControls",e.top,e.left,e.width,e.height)}})),e.neatline.neatlinemap.defaults=e.extend({},e.neatline.neatlinemap.defaults)}(jQuery),function(e,t){e.widget("neatline.configurelayout",{_create:function(){this.saveArrangementButton=e("#save-arrangement"),this.fixPositionsButton=e("#fix-positions"),this.layoutBuilder=e("#configure-layout"),this._constructDropdown(),this._instantiateLayoutBuilder(),this._addEvents()},_instantiateLayoutBuilder:function(){var e=this;this.layoutBuilder.layoutbuilder({widthDrag:function(t,n){e._trigger("widthDrag",{},n)}})},_addEvents:function(){var e=this;this.saveArrangementButton.bind({mousedown:function(){e.saveArrangement()}}),this.fixPositionsButton.bind({mousedown:function(){e._trigger("savepositions")}})},_constructDropdown:function(){this.element.nlDropdown({resize:_.bind(function(){this.layoutBuilder.layoutbuilder("getPxConstants"),this.layoutBuilder.layoutbuilder("centerAllTags")},this),showstart:_.bind(function(){this.layoutBuilder.layoutbuilder("getPxConstants"),this.layoutBuilder.layoutbuilder("centerAllTags")},this),show:_.bind(function(){this.layoutBuilder.layoutbuilder("getPxConstants"),this.layoutBuilder.layoutbuilder("centerAllTags")},this)})},setViewportProportions:function(e,t){this.layoutBuilder.layoutbuilder("applyProportions",e,t)},saveArrangement:function(){var t=this,n=this.layoutBuilder.layoutbuilder("getArrangementParameters");e.ajax({url:"ajax/arrangement",type:"POST",dataType:"json",data:n,success:function(e){t._trigger("newarrangement",{},{params:e})}})},savePositions:function(t,n,r,i,s){var o=this;e.ajax({url:"ajax/positions",type:"POST",data:{exhibit_id:Neatline.record.id,map_center:t,map_zoom:n,map_base_layer:r,timeline_center:i,timeline_zoom:s},success:function(){o._trigger("newpositions")}})}})}(jQuery),function(e,t){e.widget("neatline.configuremap",{_create:function(){this.content=e("#configure-map"),this.vectorColor=this.content.find('input[name="default-vector-color"]'),this.strokeColor=this.content.find('input[name="default-stroke-color"]'),this.highlightColor=this.content.find('input[name="default-highlight-color"]'),this.vectorOpacity=this.content.find('input[name="default-vector-opacity"]'),this.selectOpacity=this.content.find('input[name="default-select-opacity"]'),this.strokeOpacity=this.content.find('input[name="default-stroke-opacity"]'),this.graphicOpacity=this.content.find('input[name="default-graphic-opacity"]'),this.strokeWidth=this.content.find('input[name="default-stroke-width"]'),this.pointRadius=this.content.find('input[name="default-point-radius"]'),this.baseLayer=this.content.find('select[name="base-layer"]'),this.saveButton=this.content.find("button.save"),this._constructDropdown(),this._constructFormWidgets()},_constructDropdown:function(){this.element.nlDropdown()},_constructFormWidgets:function(){var e=this;this.vectorColor.miniColors({change:function(t,n){e._trigger("vectorcoloredit",{},{color:t})}}),this.strokeColor.miniColors({change:function(t,n){e._trigger("strokecoloredit",{},{color:t})}}),this.highlightColor.miniColors({change:function(t,n){e._trigger("highlightcoloredit",{},{color:t})}}),this.vectorOpacity.integerdragger({min:0,max:100,px_per_unit:1,change:function(t,n){e._trigger("vectoropacityedit",{},{value:n.value})}}),this.selectOpacity.integerdragger({min:0,max:100,px_per_unit:1,change:function(t,n){e._trigger("selectopacityedit",{},{value:n.value})}}),this.strokeOpacity.integerdragger({min:0,max:100,px_per_unit:1,change:function(t,n){e._trigger("strokeopacityedit",{},{value:n.value})}}),this.graphicOpacity.integerdragger({min:0,max:100,px_per_unit:1,change:function(t,n){e._trigger("graphicopacityedit",{},{value:n.value})}}),this.strokeWidth.integerdragger({min:0,def:1,px_per_unit:8,change:function(t,n){e._trigger("strokewidthedit",{},{value:n.value})}}),this.pointRadius.integerdragger({min:1,def:6,px_per_unit:8,change:function(t,n){e._trigger("pointradiusedit",{},{value:n.value})}}),this.saveButton.bind({mousedown:function(){e.postSettings()},click:function(e){e.preventDefault()}})},_getData:function(){var e={};return e.exhibit_id=Neatline.record.id,e.vector_color=this.vectorColor.val(),e.stroke_color=this.strokeColor.val(),e.highlight_color=this.highlightColor.val(),e.vector_opacity=parseInt(this.vectorOpacity.val(),10),e.select_opacity=parseInt(this.selectOpacity.val(),10),e.stroke_opacity=parseInt(this.strokeOpacity.val(),10),e.graphic_opacity=parseInt(this.graphicOpacity.val(),10),e.stroke_width=parseInt(this.strokeWidth.val(),10),e.point_radius=parseInt(this.pointRadius.val(),10),e.base_layer=parseInt(this.baseLayer.val(),10),e},postSettings:function(){var t=this,n=this._getData();e.ajax({url:"ajax/mapsettings",type:"POST",data:n,success:function(){t._trigger("newdefaults")}})},getAttr:function(e){return this[e]}})}(jQuery),function(e,t){e.widget("neatline.configuretimeline",{_create:function(){this.content=e("#configure-timeline"),this.bandActive=this.content.find('input[name="band-active"]'),this.bandUnit=this.content.find('select[name="band-unit"]'),this.bandHeight=this.content.find('input[name="band-height"]'),this.saveButton=this.content.find("button.save"),this._constructDropdown(),this._constructFormWidgets()},_constructDropdown:function(){this.element.nlDropdown()},_constructFormWidgets:function(){this.bandHeight.integerdragger({min:0,max:100,px_per_unit:2}),this.saveButton.bind({mousedown:_.bind(function(){this.postSettings()},this),click:function(e){e.preventDefault()}})},_getData:function(){var e={};return e.exhibit_id=Neatline.record.id,e.is_context_band=this.bandActive.is(":checked")?1:0,e.context_band_unit=this.bandUnit.val(),e.context_band_height=parseInt(this.bandHeight.val(),10),e},postSettings:function(){var t=this,n=this._getData();e.ajax({url:"ajax/timelinesettings",type:"POST",data:n,success:function(){t._trigger("newdefaults",{},n)}})},getAttr:function(e){return this[e]}})}(jQuery),function(e,t){e.widget("neatline.configureitems",{_create:function(){this.content=e("#configure-items"),this.reorderButton=this.content.find("button.loop"),this.saveButton=this.content.find("button.save"),this._isOrdering=!1,this._constructDropdown(),this._constructFormWidgets()},_constructDropdown:function(){this.element.nlDropdown()},_constructFormWidgets:function(){var e=this;this.reorderButton.bind({mousedown:function(){e._isOrdering?(e._trigger("endreorder"),e._isOrdering=!1,e.reorderButton.removeClass("btn-neatline")):(e._trigger("reorder"),e._isOrdering=!0,e.reorderButton.addClass("btn-neatline"))},click:function(e){e.preventDefault()}}),this.saveButton.bind({mousedown:function(){e.saveOrder()},click:function(e){e.preventDefault()}})},setOrder:function(e){this.order=e},saveOrder:function(){var t=this;this._trigger("getorder"),e.ajax({url:"ajax/order",type:"POST",data:{exhibit_id:Neatline.record.id,order:this.order},success:function(){t._trigger("neworder")}})}})}(jQuery),function(e,t){e.widget("neatline.togglebutton",{options:{enabled_by_default:!0,pressed_by_default:!1,visible_by_default:!0,highlight_border_color:"#6393ff",pressed_border_color:"#6393ff",pressed_text_color:"#517fe6"},_create:function(){this.element.addClass("neatline-toggle-button"),this.pressed=!1,this.enabled=!0,this._addEvents(),this.options.pressed_by_default&&this.press(),this.options.visible_by_default||this.element.css("display","none"),this.options.enabled_by_default||this.disable()},_addEvents:function(){this.element.bind({"mouseenter mouseleave":e.proxy(this._highlight,this),mousedown:e.proxy(this.press,this)})},press:function(){this.enabled&&(this.element.toggleClass("neatline-pressed"),this.pressed?(this._trigger("unpress"),this.pressed=!1):(this._trigger("press"),this.pressed=!0))},disable:function(){this.enabled=!1,this.element.css({opacity:.5,cursor:"default"})},enable:function(){this.enabled=!0,this.element.css({opacity:1,cursor:"pointer"})},isPressed:function(){return this.pressed},_highlight:function(){this.element.toggleClass("neatline-highlighted")}})}(jQuery),function(e,t){e.widget("neatline.gradientbuilder",{options:{css:{width_offset:5}},_create:function(){this._window=e(window),this.editor=this.element.find(".date-ambiguity-editor"),this.leftMarker=this.element.find(".stop-marker.left"),this.rightMarker=this.element.find(".stop-marker.right"),this.swatches=this.element.find(".color-swatch"),this.leftPercentInput=this.element.find('input[name="left-ambiguity-percentage"]'),this.rightPercentInput=this.element.find('input[name="right-ambiguity-percentage"]'),this.leftPercent=parseInt(this.leftPercentInput.val()),this.rightPercent=parseInt(this.rightPercentInput.val()),this.getDimensions(),this.positionMarkers(this.leftPercent,this.rightPercent),this.editor.spanstyler(),this._addEvents()},getDimensions:function(){this.editorWidth=this.editor.width(),this.editorHeight=this.editor.height(),this.editorOffset=this.editor.offset()},positionMarkers:function(e,t){var n=e/100,r=t/100,i=this.editorWidth*n,s=this.editorWidth-this.editorWidth*r;this.leftMarker.css({left:i-this.options.css.width_offset,top:this.editorHeight}),this.rightMarker.css({right:s-this.options.css.width_offset,top:this.editorHeight}),this.leftPercent=e,this.leftPercentInput.val(e),this.rightPercent=t,this.rightPercentInput.val(t)},setColor:function(e){this.color=e,this.editor.spanstyler("constructCss",e,this.leftPercent,this.rightPercent),this.editor.spanstyler("applyCss"),this.swatches.css("background",e)},refresh:function(){this.getDimensions(),this.positionMarkers(this.leftPercent,this.rightPercent),this.setColor(this.color)},_addEvents:function(){var e=this;this.leftMarker.bind({mousedown:function(t){e._doLeftDrag(t)}}),this.rightMarker.bind({mousedown:function(t){e._doRightDrag(t)}})},_doLeftDrag:function(e){var t=this,n=e.pageX,r=this.__pxToInt(this.leftMarker.css("left"));this._window.bind({mousemove:function(e){var i=e.pageX-n,s=r+i,o=t._leftPercentFromOffset(s);s+t.options.css.width_offset>=0&&o<t.rightPercent-5?t.leftMarker.css("left",s):o>=t.rightPercent-5?s=(t.rightPercent-5)/100*t.editorWidth:(s=-t.options.css.width_offset,t.leftMarker.css("left",s)),t.leftPercent=t._leftPercentFromOffset(s),t.leftPercentInput.val(t.leftPercent),t.editor.spanstyler("constructCss",t.color,t.leftPercent,t.rightPercent),t.editor.spanstyler("applyCss"),t._trigger("stopHandleDrag",{},{color:t.color,leftPercent:t.leftPercent,rightPercent:t.rightPercent})},mouseup:function(){t._window.unbind("mousemove mouseup")}})},_doRightDrag:function(e){var t=this,n=e.pageX,r=this.__pxToInt(this.rightMarker.css("right"));this._window.bind({mousemove:function(e){var i=e.pageX-n,s=r-i,o=t._rightPercentFromOffset(s);s+t.options.css.width_offset>=0&&o>t.leftPercent+5?t.rightMarker.css("right",s):o<=t.leftPercent+5?(s=t.editorWidth-(t.leftPercent+5)/100*t.editorWidth,t.rightMarker.css("right",s)):(s=-t.options.css.width_offset,t.rightMarker.css("right",s)),t.rightPercent=t._rightPercentFromOffset(s),t.rightPercentInput.val(t.rightPercent),t.editor.spanstyler("constructCss",t.color,t.leftPercent,t.rightPercent),t.editor.spanstyler("applyCss"),t._trigger("stopHandleDrag",{},{color:t.color,leftPercent:t.leftPercent,rightPercent:t.rightPercent})},mouseup:function(){t._window.unbind("mousemove mouseup")}})},_leftPercentFromOffset:function(e){return Math.round((e+this.options.css.width_offset)/this.editorWidth*100)},_rightPercentFromOffset:function(e){return Math.round((this.editorWidth-e-this.options.css.width_offset)/this.editorWidth*100)},__pxToInt:function(e){var t=e.indexOf("px");return parseInt(e.slice(0,t))}})}(jQuery),function(e,t){e.widget("neatline.nlDropdown",{options:{markup:{content:"div.dropdown-content",topbar:"#topbar"},css:{duration:400},radios:[]},_create:function(){this._body=e("body"),this._window=e(window),this.topbar=e(this.options.markup.topbar),this.radios=this.options.radios,this.content=this.element.next(this.options.markup.content),this.content.detach(),e("body").append(this.content),this._expanded=!1,this._measure(),this._addEvents()},_measure:function(){this.contentWidth=this.content.width(),this.contentHeight=this.content.height(),this.topbarHeight=this.topbar.height(),this.buttonWidth=this.element.width()},_getOffsets:function(){this.buttonOffset=this.element.offset(),this.topbarHeight=this.topbar.height()},_addEvents:function(){var e=this;this.element.bind({mousedown:function(){e._expanded?e.hide():e.show()},click:function(e){e.preventDefault()}}),this._window.bind("resize",function(){e.position(),e._trigger("resize")})},setRadioDropdowns:function(e){this.radios=e},position:function(){var e;this._getOffsets(),this._expanded?(e=this.topbarHeight,this.content.css({left:Math.max(0,this.buttonOffset.left+this.buttonWidth-this.contentWidth),top:e})):(e=this.contentHeight-this.topbarHeight,this.content.css({left:Math.max(0,this.buttonOffset.left+this.buttonWidth-this.contentWidth),top:-e}))},show:function(){if(_.isArray(this.radios)&&this.radios.length>0){var e=_.filter(this.radios,function(e){return e._expanded}),t=this._createRadioSetHideCont(e,e.length,0);t()}else this._show()},_createRadioSetHideCont:function(e,t,n){var r=this;return function(){var s=n+1;n>=t?r._show():e[n].hide(r._createRadioSetHideCont(e,t,s))}},_show:function(){var e=this;this.position(),this.content.css("display","block"),this._trigger("showstart"),this.content.stop().animate({top:this.topbarHeight},this.options.css.duration,function(){e._trigger("show")}),this.element.addClass("open"),this._expanded=!0},hide:function(e){var t=this;this.content.stop().animate({top:-this.contentHeight},this.options.css.duration,function(){t.content.css("display","none"),t._trigger("hide"),_.isFunction(e)&&e()}),this.element.removeClass("open"),this._expanded=!1}})}(jQuery),function(e,t){e.widget("neatline.integerdragger",{options:{min:null,max:null,def:0,px_per_unit:5,tip:{show:!0,text:"click and drag",padding:10,"class":"intdragger-tooltip"}},_create:function(){this._body=e("body"),this._window=e(window),this.currentVal=null,this.isDragging=!1,this._setStartingValue(),this.options.tip.show&&this._buildToolTip(),this._addEvents()},_buildToolTip:function(){this.tip=e("<span></span>").addClass(this.options.tip["class"]).text(this.options.tip.text).css("position","absolute"),this.tipHeight=this._measureToolTip(),this.inputHeight=this.element.outerHeight(!1),this.inputWidth=this.element.outerWidth()},_addEvents:function(){var e=this;this.element.bind({mouseenter:function(){e.options.tip.show&&!e.isDragging&&e._showToolTip()},mouseleave:function(){e.options.tip.show&&!e.isDragging&&e._hideToolTip()},keyup:function(){var t=e.element.val();t!==""&&e._setInputValue(parseInt(e.element.val(),10))},mousedown:function(t){e.isDragging=!0;var n=t.pageY,r=parseInt(e.element.val(),10);e._window.bind({mousemove:function(t){var i=(n-t.pageY)/e.options.px_per_unit;e._setInputValue(r+Math.round(i))},mouseup:function(){e.isDragging=!1,e._window.unbind("mousemove"),e.options.tip.show&&e._hideToolTip()}})}})},_setStartingValue:function(){var e=this.element.val();isNaN(parseInt(e))?this._setInputValue(this.options.def):this._setInputValue(e)},_setInputValue:function(e){return this.options.min!=null&&e<this.options.min?(this.element.val(this.options.min),this.currentVal=this.options.min,!1):this.options.max!=null&&e>this.options.max?(this.element.val(this.options.max),this.currentVal=this.options.max,!1):_.isNaN(e)?(this.element.val(this.options.def),this.currentVal=this.options.def,!1):(this.element.val(e),this.currentVal=e,this._trigger("change",{},{value:this.currentVal}),!0)},_measureToolTip:function(){return this.tip.css({top:-1e3,left:-1e3}).appendTo(this._body),this.tip.height()},_showToolTip:function(){var e=this.element.offset(),t=(this.inputHeight-this.tipHeight)/2;this.tip.css({top:e.top+t,left:e.left+this.inputWidth+this.options.tip.padding,opacity:0}),this._body.append(this.tip),this.tip.animate({opacity:1},200)},_hideToolTip:function(){var e=this;this.tip.animate({opacity:0},200,function(){e.tip.remove()})}})}(jQuery),jQuery(document).ready(function(e){var t=e("#neatline"),n=e("#item-browser"),r=e("#configure-layout-button"),i=e("#configure-map-button"),s=e("#configure-timeline-button"),o=e("#configure-items-button");n.itembrowser({neatlineready:function(){t.neatline({isPublic:!1,timelineeventclick:function(e,t){n.itembrowser("showFormByRecordId",t.recordid,!0,!1,!0)},mapfeatureclick:function(e,t){n.itembrowser("showFormByRecordId",t.recordid,!1,!0,!0)},itemclick:function(e,t){n.itembrowser("showFormByRecordId",t.recordid,!0,!0,t.scrollItems)},mapfeatureadded:function(e,t){n.itembrowser("updateGeocoverage",t.geocoverage)},newitems:function(){var e=n.itembrowser("getCurrentEditId");e&&t.neatline("showItemDescription",e)},widthdrag:function(e,t){r.configurelayout("setViewportProportions",t.h_percent,t.v_percent)}}),t.on({drawingmodeon:function(){var e=n.data("itembrowser");e.editForm!=null&&e.editForm.itemform("lockForm")},drawingmodeoff:function(){var e=n.data("itembrowser");e.editForm!=null&&e.editForm.itemform("unlockForm")}})},reposition:function(){t.neatline("positionDivs"),t.neatline("positionBlockMarkup")},mapedit:function(e,n){t.neatline("editMap",n.item,n.immediate)},endmapedit:function(e,n){t.neatline("endMapEditWithoutSave",n.immediate)},savecomplete:function(){t.neatline("reloadTimeline"),t.neatline("reloadMap"),t.neatline("reloadItems")},itemedit:function(e,n){n.scrollMap&&t.neatline("zoomMapToItemVectors",n.recordid),n.scrollTimeline&&t.neatline("zoomTimelineToEvent",n.recordid),n.focusItems&&t.neatline("showItemDescription",n.recordid)},vectorcoloredit:function(e,n){t.neatline("setItemVectorColor",n.color,n.recordid)},strokecoloredit:function(e,n){t.neatline("setItemStrokeColor",n.color)},highlightcoloredit:function(e,n){t.neatline("setItemHighlightColor",n.color)},vectoropacityedit:function(e,n){t.neatline("setItemVectorOpacity",n.value)},strokeopacityedit:function(e,n){t.neatline("setItemStrokeOpacity",n.value)},graphicopacityedit:function(e,n){t.neatline("setItemGraphicOpacity",n.value)},strokewidthedit:function(e,n){t.neatline("setItemStrokeWidth",n.value)},pointradiusedit:function(e,n){t.neatline("setItemPointRadius",n.value)},ambiguityChange:function(e,n){t.neatline("setDateAmbiguity",n.recordid,n.color,n.leftPercent,n.rightPercent)},savemapfocus:function(){var e=t.neatline("getMapCenter"),r=t.neatline("getMapZoom");n.itembrowser("saveMapFocus",e,r)},saveform:function(){var e=t.neatline("getWktForSave");n.itembrowser("saveForm",e)}}),r.configurelayout({savepositions:function(){var e=t.neatline("getMapCenter"),n=t.neatline("getMapZoom"),i=t.neatline("getMapBaseLayer"),s=t.neatline("getTimelineCenter"),o=t.neatline("getTimelineZoom");r.configurelayout("savePositions",e,n,i,s,o)},newarrangement:function(e,n){t.neatline("setParams",n.params),t.neatline("positionDivs"),t.neatline("positionBlockMarkup"),t.neatline("instantiateBlocks"),t.neatline("saveSuccess")},newpositions:function(){t.neatline("saveSuccess")},widthDrag:function(e,n){t.neatline("applyViewportProportions",n.h_percent,n.v_percent)}}),i.configuremap({vectorcoloredit:function(e,n){t.neatline("setDefaultVectorColor",n.color)},strokecoloredit:function(e,n){t.neatline("setDefaultStrokeColor",n.color)},highlightcoloredit:function(e,n){t.neatline("setDefaultHighlightColor",n.color)},vectoropacityedit:function(e,n){t.neatline("setDefaultVectorOpacity",n.value)},strokeopacityedit:function(e,n){t.neatline("setDefaultStrokeOpacity",n.value)},graphicopacityedit:function(e,n){t.neatline("setItemGraphicOpacity",n.value)},strokewidthedit:function(e,n){t.neatline("setDefaultStrokeWidth",n.value)},pointradiusedit:function(e,n){t.neatline("setDefaultPointRadius",n.value)},newdefaults:function(e,r){t.neatline("saveSuccess"),n.itembrowser("reloadItemForm")}}),s.configuretimeline({newdefaults:function(e,n){t.neatline("saveSuccess"),t.neatline("renderTimelineDefaults",n.context_band_height,n.context_band_unit,n.is_context_band)}}),o.configureitems({reorder:function(){t.neatline("reorderItems")},getorder:function(){var e=t.neatline("getOrder");o.configureitems("setOrder",e)},endreorder:function(){var e=t.neatline("endReorderItems");o.configureitems("setOrder",e)},neworder:function(e,n){t.neatline("saveSuccess")}});var u=[r.data("configurelayout").element.data("nlDropdown"),i.data("configuremap").element.data("nlDropdown"),s.data("configuretimeline").element.data("nlDropdown"),o.data("configureitems").element.data("nlDropdown")],a,f;_.each(u,function(e){e.setRadioDropdowns(u)})}),jQuery&&function(e){e.extend(e.fn,{miniColors:function(t,n){var r=function(t,n,r){var i=m(t.val());i||(i="FFFFFF");var s=E(i),f=e('<a class="miniColors-trigger" style="background-color: #'+i+'" href="#"></a>');f.insertAfter(t),t.addClass("miniColors").attr("maxlength",7).attr("autocomplete","off"),t.data("trigger",f),t.data("hsb",s),n.change&&t.data("change",n.change),n.readonly&&t.attr("readonly",!0),n.disabled&&o(t),f.bind("click.miniColors",function(e){e.preventDefault(),t.trigger("focus")}),t.bind("focus.miniColors",function(e){u(t)}),t.bind("blur.miniColors",function(e){var n=m(t.val());t.val(n?"#"+n:"")}),t.bind("keydown.miniColors",function(e){e.keyCode===9&&a(t)}),t.bind("keyup.miniColors",function(e){var n=t.val().replace(/[^A-F0-9#]/ig,"");t.val(n),p(t)||t.data("trigger").css("backgroundColor","#FFF")}),t.bind("paste.miniColors",function(e){setTimeout(function(){t.trigger("keyup")},5)})},i=function(t){a(),t=e(t),t.data("trigger").remove(),t.removeAttr("autocomplete"),t.removeData("trigger"),t.removeData("selector"),t.removeData("hsb"),t.removeData("huePicker"),t.removeData("colorPicker"),t.removeData("mousebutton"),t.removeData("moving"),t.unbind("click.miniColors"),t.unbind("focus.miniColors"),t.unbind("blur.miniColors"),t.unbind("keyup.miniColors"),t.unbind("keydown.miniColors"),t.unbind("paste.miniColors"),e(document).unbind("mousedown.miniColors"),e(document).unbind("mousemove.miniColors")},s=function(e){e.attr("disabled",!1),e.data("trigger").css("opacity",1)},o=function(e){a(e),e.attr("disabled",!0),e.data("trigger").css("opacity",.5)},u=function(t){if(t.attr("disabled"))return!1;a();var n=e('<div class="miniColors-selector"></div>');n.append('<div class="miniColors-colors" style="background-color: #FFF;"><div class="miniColors-colorPicker"></div></div>'),n.append('<div class="miniColors-hues"><div class="miniColors-huePicker"></div></div>'),n.css({top:t.is(":visible")?t.offset().top+t.outerHeight():t.data("trigger").offset().top+t.data("trigger").outerHeight(),left:t.is(":visible")?t.offset().left:t.data("trigger").offset().left,display:"none"}).addClass(t.attr("class"));var r=t.data("hsb");n.find(".miniColors-colors").css("backgroundColor","#"+S({h:r.h,s:100,b:100}));var i=t.data("colorPosition");i||(i=d(r)),n.find(".miniColors-colorPicker").css("top",i.y+"px").css("left",i.x+"px");var s=t.data("huePosition");s||(s=v(r)),n.find(".miniColors-huePicker").css("top",s.y+"px"),t.data("selector",n),t.data("huePicker",n.find(".miniColors-huePicker")),t.data("colorPicker",n.find(".miniColors-colorPicker")),t.data("mousebutton",0),e("BODY").append(n),n.fadeIn(100),n.bind("selectstart",function(){return!1}),e(document).bind("mousedown.miniColors",function(n){t.data("mousebutton",1),e(n.target).parents().andSelf().hasClass("miniColors-colors")&&(n.preventDefault(),t.data("moving","colors"),f(t,n)),e(n.target).parents().andSelf().hasClass("miniColors-hues")&&(n.preventDefault(),t.data("moving","hues"),l(t,n));if(e(n.target).parents().andSelf().hasClass("miniColors-selector")){n.preventDefault();return}if(e(n.target).parents().andSelf().hasClass("miniColors"))return;a(t)}),e(document).bind("mouseup.miniColors",function(e){t.data("mousebutton",0),t.removeData("moving")}),e(document).bind("mousemove.miniColors",function(e){t.data("mousebutton")===1&&(t.data("moving")==="colors"&&f(t,e),t.data("moving")==="hues"&&l(t,e))})},a=function(t){t||(t=".miniColors"),e(t).each(function(){var t=e(this).data("selector");e(this).removeData("selector"),e(t).fadeOut(100,function(){e(this).remove()})}),e(document).unbind("mousedown.miniColors"),e(document).unbind("mousemove.miniColors")},f=function(t,n){var r=t.data("colorPicker");r.hide();var i={x:n.clientX-t.data("selector").find(".miniColors-colors").offset().left+e(document).scrollLeft()-5,y:n.clientY-t.data("selector").find(".miniColors-colors").offset().top+e(document).scrollTop()-5};i.x<=-5&&(i.x=-5),i.x>=144&&(i.x=144),i.y<=-5&&(i.y=-5),i.y>=144&&(i.y=144),t.data("colorPosition",i),r.css("left",i.x).css("top",i.y).show();var s=Math.round((i.x+5)*.67);s<0&&(s=0),s>100&&(s=100);var o=100-Math.round((i.y+5)*.67);o<0&&(o=0),o>100&&(o=100);var u=t.data("hsb");u.s=s,u.b=o,c(t,u,!0)},l=function(t,n){var r=t.data("huePicker");r.hide();var i={y:n.clientY-t.data("selector").find(".miniColors-colors").offset().top+e(document).scrollTop()-1};i.y<=-1&&(i.y=-1),i.y>=149&&(i.y=149),t.data("huePosition",i),r.css("top",i.y).show();var s=Math.round((150-i.y-1)*2.4);s<0&&(s=0),s>360&&(s=360);var o=t.data("hsb");o.h=s,c(t,o,!0)},c=function(e,t,n){e.data("hsb",t);var r=S(t);n&&e.val("#"+r),e.data("trigger").css("backgroundColor","#"+r),e.data("selector")&&e.data("selector").find(".miniColors-colors").css("backgroundColor","#"+S({h:t.h,s:100,b:100})),e.data("change")&&e.data("change").call(e,"#"+r,g(t))},p=function(t){var n=m(t.val());if(!n)return!1;var r=E(n),i=t.data("hsb");if(r.h===i.h&&r.s===i.s&&r.b===i.b)return!0;var s=d(r),o=e(t.data("colorPicker"));o.css("top",s.y+"px").css("left",s.x+"px");var u=v(r),a=e(t.data("huePicker"));return a.css("top",u.y+"px"),c(t,r,!1),!0},d=function(e){var t=Math.ceil(e.s/.67);t<0&&(t=0),t>150&&(t=150);var n=150-Math.ceil(e.b/.67);return n<0&&(n=0),n>150&&(n=150),{x:t-5,y:n-5}},v=function(e){var t=150-e.h/2.4;return t<0&&(h=0),t>150&&(h=150),{y:t-1}},m=function(e){return e=e.replace(/[^A-Fa-f0-9]/,""),e.length==3&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),e.length===6?e:null},g=function(e){var t={},n=Math.round(e.h),r=Math.round(e.s*255/100),i=Math.round(e.b*255/100);if(r==0)t.r=t.g=t.b=i;else{var s=i,o=(255-r)*i/255,u=(s-o)*(n%60)/60;n==360&&(n=0),n<60?(t.r=s,t.b=o,t.g=o+u):n<120?(t.g=s,t.b=o,t.r=s-u):n<180?(t.g=s,t.r=o,t.b=o+u):n<240?(t.b=s,t.r=o,t.g=s-u):n<300?(t.b=s,t.g=o,t.r=o+u):n<360?(t.r=s,t.g=o,t.b=s-u):(t.r=0,t.g=0,t.b=0)}return{r:Math.round(t.r),g:Math.round(t.g),b:Math.round(t.b)}},y=function(t){var n=[t.r.toString(16),t.g.toString(16),t.b.toString(16)];return e.each(n,function(e,t){t.length==1&&(n[e]="0"+t)}),n.join("")},b=function(e){var e=parseInt(e.indexOf("#")>-1?e.substring(1):e,16);return{r:e>>16,g:(e&65280)>>8,b:e&255}},w=function(e){var t={h:0,s:0,b:0},n=Math.min(e.r,e.g,e.b),r=Math.max(e.r,e.g,e.b),i=r-n;return t.b=r,t.s=r!=0?255*i/r:0,t.s!=0?e.r==r?t.h=(e.g-e.b)/i:e.g==r?t.h=2+(e.b-e.r)/i:t.h=4+(e.r-e.g)/i:t.h=-1,t.h*=60,t.h<0&&(t.h+=360),t.s*=100/255,t.b*=100/255,t},E=function(e){var t=w(b(e));return t.s===0&&(t.h=360),t},S=function(e){return y(g(e))};switch(t){case"readonly":return e(this).each(function(){e(this).attr("readonly",n)}),e(this);case"disabled":return e(this).each(function(){n?o(e(this)):s(e(this))}),e(this);case"value":return e(this).each(function(){e(this).val(n).trigger("keyup")}),e(this);case"destroy":return e(this).each(function(){i(e(this))}),e(this);default:return t||(t={}),e(this).each(function(){if(e(this)[0].tagName.toLowerCase()!=="input")return;if(e(this).data("trigger"))return;r(e(this),t,n)}),e(this)}}})}(jQuery);